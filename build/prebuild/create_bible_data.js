import { bibleData, versionData } from "./bible_data";

const fs = require("fs");
const crypto = require("crypto");

const hashFile = (filename) => {
  var f = fs.readFileSync(__dirname + filename);
  var md5 = crypto.createHash("md5");
  md5.update(f, "utf-8");
  return md5.digest("hex");
};

const createJSFile = () => {
  let data = `// DO NOT EDIT - THIS FILE IS AUTOGENERATED\nexport const bibleData = [`;
  for (let i = 0; i < bibleData.length; i++) {
    const bookData = bibleData[i];
    data += `
    {
      name: "${bookData.name}",
      abbreviation: "${bookData.abbreviation}",
      num_chapters: ${bookData.num_chapters},
      num_verses: [${bookData.num_verses.join(",")}],`;
    if ("superscripts" in bookData) {
      data += `
      superscripts: [${bookData.superscripts.join(",")}],`;
    }
    data += `
      prologue: ${"prologue" in bookData ? bookData.prologue : 0},
      testament: "${bookData.testament}",
    },`;
  }
  data += "\n] as const;\n\n";

  data += `export const versionData = {`;
  for (let [version, versionInfo] of Object.entries(versionData)) {
    data += `
  ${version}: {
    fullname: "${versionInfo.fullname}",
    language: "${versionInfo.language}",
    books: [
${versionInfo.books.map((x) => `      { book_number: ${x.book_number}, name: "${x.name}" },`).join("\n")}
    ],
  },`;
  }
  data += `\n} as const;`;

  fs.writeFileSync(
    __dirname + "/../../frontend/src/lib/Scripture/data.ts",
    data,
  );
};

const createGoFile = () => {
  let data = `package app
// DO NOT EDIT - THIS FILE IS AUTOGENERATED

type BookData struct {
  name         string
  abbreviation string
  num_chapters int
  num_verses   []int
  superscripts []int
  prologue     int
  testament    string
}

type VersionBookData struct {
	book_number int
	name        string
}

type VersionData struct {
	name     string
	fullname string
	language string
	books    []VersionBookData
}

var bibleData = [...]BookData{`;
  for (let i = 0; i < bibleData.length; i++) {
    const bookData = bibleData[i];
    data += `
  {
    name: "${bookData.name}",
    abbreviation: "${bookData.abbreviation}",
    num_chapters: ${bookData.num_chapters},
    num_verses: []int{${bookData.num_verses.join(",")}},`;
    if ("superscripts" in bookData) {
      data += `
    superscripts: []int{${bookData.superscripts.join(",")}},`;
    }
    data += `
    prologue: ${"prologue" in bookData ? bookData.prologue : 0},
    testament: "${bookData.testament}",
  },`;
  }
  data += "\n}\n\n";

  data += `var versionData = [...]VersionData{\n`;
  for (let [version, versionInfo] of Object.entries(versionData)) {
    data += `  {
    name: "${version}",
    fullname: "${versionInfo.fullname}",
    language: "${versionInfo.language}",
    books: []VersionBookData{`;
    for (let i = 0; i < versionInfo.books.length; i++) {
      data += `
      {
        book_number: ${versionInfo.books[i].book_number},
        name:  "${versionInfo.books[i].name}",
      },`;
    }
    data += `\n    },\n  },\n`;
  }
  data += `}`;

  fs.writeFileSync(__dirname + "/../../internal/app/scripture_data.go", data);
};

export const createBibleData = () => {
  // Ensure this code only gets run on file change to `bible_data.js`
  let hash = hashFile("/bible_data.js");
  if (hash == fs.readFileSync(__dirname + "/bible_data.lock")) return;
  fs.writeFileSync(__dirname + "/bible_data.lock", hash);

  createJSFile(); // `frontend/src/lib/Scripture/data.ts`
  createGoFile(); // `internal/app/scripture_data.go`
};
